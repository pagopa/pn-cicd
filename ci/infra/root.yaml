AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Genera il repository maven e include gli stack di generazione dei CodeBuild project per 
  effettuare il build di librerie, microservizi e webapp.

Parameters:
  PnCiCdTemplatesBucketName:
    Type: String
    Description: Bucket name where pipeline copied the current version of CI templates
  CodeArtifactDomainName:
    Type: String
    Default: pn-codeartifact-domain
  CodeArtifactRepositoryName:
    Type: String
    Default: pn-codeartifact-repo
  NotificationSNSTopic:
    Type: String
    Default: 'none'
    Description: Topic for build and pipeline notification
  
  AllowedDeployAccount1:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount2:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount3:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount4:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount5:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount6:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount7:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount8:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount9:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount10:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount11:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount12:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount13:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount14:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount15:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount16:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount17:
    Type: Number
    Description: Account number allowed to read the artifacts
  AllowedDeployAccount18:
    Type: Number
    Description: Account number allowed to read the artifacts


Resources:
  CodeArtifactStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/infra/code-artifact.yaml'
      Parameters:
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
      TimeoutInMinutes: 5

  CiArtifactBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      VersioningConfiguration:
        Status: Enabled
  
  CiEventBus:
    Type: AWS::Events::EventBus
    Properties: 
      Name: 'CiEventBus'
  
  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CiArtifactBucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:*
            Effect: Allow
            Resource:
              - !Sub arn:aws:s3:::${CiArtifactBucket}
              - !Sub arn:aws:s3:::${CiArtifactBucket}/*
            Principal:
              AWS:
                - !Sub arn:aws:iam::${AllowedDeployAccount1}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount2}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount3}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount4}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount5}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount6}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount7}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount8}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount9}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount10}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount11}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount12}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount13}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount14}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount15}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount16}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount17}:root
                - !Sub arn:aws:iam::${AllowedDeployAccount18}:root

# Progetti CI jar
  ParentPomCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-jar-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-parent'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnModelCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-jar-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-model'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnCommonsCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-jar-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-commons'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
# Progetti docker
  PnDeliveryCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-delivery'
        DisableIntegrationTest: 'false'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        GitHubDefaultBranch: 'develop'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnDeliveryPushCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-delivery-push'
        DisableIntegrationTest: 'false'
        GitHubDefaultBranch: 'develop'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 20
  PnExternalChannelsCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-external-channels'
        GitHubDefaultBranch: 'develop'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnDataVaultCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-data-vault'
        DisableIntegrationTest: 'false'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnNationalRegistriesCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-national-registries'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnExternalRegistriesCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-external-registries'
        DisableIntegrationTest: 'false'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnMandateCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-mandate'
        DisableIntegrationTest: 'false'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnUserAttributesCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-user-attributes'
        DisableIntegrationTest: 'false'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnDowntimeLogsCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-downtime-logs'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnRaddFsuCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-radd-fsu'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnLogExtractorBeCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-logextractor-be'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnLogsaverBeCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-logsaver-be'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
  PnApikeyManagerCI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/mvn-docker-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-apikey-manager'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
        AllowedDeployAccount1: !Ref AllowedDeployAccount1
        AllowedDeployAccount2: !Ref AllowedDeployAccount2
        AllowedDeployAccount3: !Ref AllowedDeployAccount3
        AllowedDeployAccount4: !Ref AllowedDeployAccount4
        AllowedDeployAccount5: !Ref AllowedDeployAccount5
        AllowedDeployAccount6: !Ref AllowedDeployAccount6
        AllowedDeployAccount7: !Ref AllowedDeployAccount7
        AllowedDeployAccount8: !Ref AllowedDeployAccount8
        AllowedDeployAccount9: !Ref AllowedDeployAccount9
        AllowedDeployAccount10: !Ref AllowedDeployAccount10
        AllowedDeployAccount11: !Ref AllowedDeployAccount11
        AllowedDeployAccount12: !Ref AllowedDeployAccount12
        AllowedDeployAccount13: !Ref AllowedDeployAccount13
        AllowedDeployAccount14: !Ref AllowedDeployAccount14
        AllowedDeployAccount15: !Ref AllowedDeployAccount15
        AllowedDeployAccount16: !Ref AllowedDeployAccount16
        AllowedDeployAccount17: !Ref AllowedDeployAccount17
        AllowedDeployAccount18: !Ref AllowedDeployAccount18
        AllowedDeployAccount19: !Ref AllowedDeployAccount18
        AllowedDeployAccount20: !Ref AllowedDeployAccount18
      TimeoutInMinutes: 5
# Progetti Lambda
  PnApikeyAuthorizerLambda:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/nodejs-lambda-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-auth-fleet'
        BaseDir: 'apikeyAuthorizer'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnIoAuthorizerLambda:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/nodejs-lambda-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-auth-fleet'
        BaseDir: 'ioAuthorizer'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnJwtAuthorizerLambda:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/nodejs-lambda-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-auth-fleet'
        BaseDir: 'jwtAuthorizer'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnTokenExchangeLambda:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/nodejs-lambda-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-auth-fleet'
        BaseDir: 'tokenExchange'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5

  # Progetti WebApp
  PnPaWebapp:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/webapp-standard-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-frontend'
        PackageName: 'pn-pa-webapp'
        BaseDir: 'packages/pn-pa-webapp'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnPfWebapp:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/webapp-standard-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-frontend'
        PackageName: 'pn-personafisica-webapp'
        BaseDir: 'packages/pn-personafisica-webapp'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnLoginWebapp:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/webapp-standard-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-frontend'
        PackageName: 'pn-personafisica-login'
        BaseDir: 'packages/pn-personafisica-login'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnLandingWebapp:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/webapp-standard-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-frontend'
        PackageName: 'pn-landing-webapp'
        BaseDir: 'packages/pn-landing-webapp'
        CodeArtifactDomainName: !Ref 'CodeArtifactDomainName'
        CodeArtifactRepositoryName: !Ref 'CodeArtifactRepositoryName'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  
  # Sonar per pn-frontend
  PnFrontendSonar:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/webapp-sonar-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-frontend'
        BaseDir: '.'
      TimeoutInMinutes: 5

  # Progetti template CFN
  PnInfra:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/infra-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-infra'
        CiArtifactBucket: !Ref 'CiArtifactBucket'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5
  PnCiCd:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.amazonaws.com/${PnCiCdTemplatesBucketName}/ci/builders/not-compiled-repo-codebuild.yaml'
      Parameters:
        GitHubProjectName: 'pn-cicd'
        GitHubDefaultBranch: 'main'
        NotificationSNSTopic: !Ref 'NotificationSNSTopic'
      TimeoutInMinutes: 5

Outputs:
  CiArtifactBucket:
    Value: !Ref 'CiArtifactBucket'
